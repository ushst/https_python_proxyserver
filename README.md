# HTTPS Proxy Server

Этот репозиторий содержит простой асинхронный HTTPS-прокси-сервер на Python с поддержкой Basic-авторизации и управлением пользователями.

## Требования
- Python 3.10 или новее.
- Компилятор/библиотеки для сборки `bcrypt` (на Linux достаточно установить `build-essential` и `python3-dev`).
- Действующий TLS-сертификат и приватный ключ в формате PEM.

## Установка
1. Склонируйте репозиторий и перейдите в каталог проекта:
   ```bash
   git clone <URL> https_python_proxyserver
   cd https_python_proxyserver
   ```
2. (Необязательно) создайте и активируйте виртуальное окружение:
   ```bash
   python3 -m venv .venv
   source .venv/bin/activate
   ```
3. Установите зависимости:
   ```bash
   pip install -r requirements.txt
   ```

## Настройка
1. Создайте файл `.env`, основываясь на примере `.env_example`:
   ```bash
   cp .env_example .env
   ```
   Заполните пути к сертификату (`SSL_CERT`) и приватному ключу (`SSL_KEY`), а также при необходимости скорректируйте остальные параметры (порт, realm и т.д.).
2. Создайте файл с учетными данными пользователей. По умолчанию он размещается в `./pass`, путь настраивается переменной `PASS_FILE` в `.env`.
   - Добавить пользователя можно через скрипт `manage_users.py`:
     ```bash
     python manage_users.py add <username>
     ```
   - Удалить:
     ```bash
     python manage_users.py del <username>
     ```
   - Посмотреть список:
     ```bash
     python manage_users.py list
     ```
3. (Опционально) Чтобы направлять трафик через внешний HTTP(S)-прокси, задайте переменную окружения `UPSTREAM_PROXY`.
   - Формат: `http[s]://[user:password@]proxy.example.org:3128`.
   - При включении режима сервер будет работать как MITM-прокси: клиент подключается к вашему серверу, а все запросы и туннели (`CONNECT`) автоматически пробрасываются через указанный апстрим (включая базовую авторизацию, если логин и пароль заданы в URL).
   - Поддерживаются как обычные HTTP-прокси, так и HTTPS-прокси (в этом случае сертификат апстрим-сервера проверяется системным хранилищем). Если переменная не задана, сервер работает в прежнем режиме прямого подключения к целевым хостам.
4. (Опционально) Если клиент ожидает обычный HTTP-прокси без TLS, установите переменную окружения `ENABLE_SSL=0`. В этом режиме входящие подключения не оборачиваются в TLS, поэтому первый запрос `CONNECT` от клиента будет принят в виде обычного HTTP.

## Запуск
Запустите сервер командой:
```bash
python proxy_async.py
```

Сервер будет слушать адрес и порт, указанные в `.env` (по умолчанию `0.0.0.0:8443`) и требовать Basic-авторизацию. Для успешной аутентификации клиент должен передавать имя пользователя и пароль, соответствующие хешам в файле `PASS_FILE` (используется алгоритм `bcrypt`).

### Режим отладки

Если при подключении возникают ошибки и требуется подробное логирование, запустите сервер с ключом `--debug`:

```bash
python proxy_async.py --debug
```

Альтернативно можно установить переменную окружения `DEBUG=1` (например, добавить в `.env`). В режиме отладки выводятся диагностические сообщения и активируется отладка event loop `asyncio`, что помогает исследовать проблемы с соединениями.

## Установка как systemd-сервис

Для автоматического запуска сервера при старте системы доступен скрипт `install_proxy_service.sh`. Он создаёт unit-файл systemd, перезагружает демон и (по умолчанию) активирует сервис.

```bash
sudo ./install_proxy_service.sh \
  -u proxyuser \
  -g proxyuser \
  -p /usr/bin/python3 \
  -w /opt/https_python_proxyserver
```

Параметры можно опустить — скрипт постарается подобрать разумные значения (путь к Python определяется автоматически, рабочий каталог принимается равным каталогу репозитория, а в качестве пользователя используется `proxy`). Если в рабочем каталоге есть файл `.env`, он будет подключён автоматически. Дополнительные опции можно посмотреть с помощью `sudo ./install_proxy_service.sh -h`.

## Служебная информация
- `proxy_async.py` — основной файл сервера.
- `manage_users.py` — вспомогательный скрипт для управления пользователями.
- `requirements.txt` — список зависимостей.

